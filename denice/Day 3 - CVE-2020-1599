rule cve_2020_1599
{
	meta:
		author = "de3ev"
		desc = "Detecting CVE-2020-1599, sample from VX"
		hash = "1258FB78DD50F6C12C3181CC5C1362DC9D70CA46C5FD7E6AF4880EE6D6D9E7A2"

	strings:
		$dll1 = "elscore.dll"
		$dll2 = "PROPSYS.dll"
		$dll3 = "urlmon.dll"
		$dll4 = "Bcp47Langs.dll"
		$s1 = "CreateMutex" wide
		$s2 = "Software\\Microsoft\\Windows\\CurrentVersion\\UFH\\SHC"
		$s3 = "AppResolver.pdb"
		$s4 = "Local\\SM0:%d:%d:%hs" wide
		$s5 = "%hs(%u)\\%hs!%p:" wide
		$im1 = "IsDebuggerPresent"
		$im2 = "KillTimer"
		$im3 = "DestroyWindow"
		$im4 = "SetTimer"
		$im5 = "SendNotifyMessageW"
		$shell = "cmd.exe /c powershell.exe -inputformat none -outputformat none -NonInteractive -Command Add-MpPreference -ExclusionPath '%USERPROFILE%\\AppData\\Roaming'"
		$shell2 = "cmd.exe /c powershell.exe -inputformat none -outputformat none -NonInteractive -Command Add-MpPreference -ExclusionPath 'C:\\Windows\\System32\\WindowsPowerShell\\*'"
		$shell3 = "cmd.exe /c powershell.exe -command Set-MpPreference -DisableRealtimeMonitoring $true"
		$shell4 = "cmd.exe /c powershell.exe -command Set-MpPreference -DisableBehaviorMonitoring $true"
		$shell5 = "cmd.exe /c powershell.exe -command Set-MpPreference -DisableIOAVProtection $true"
		$shell6 = "cmd.exe /c powershell.exe -command Set-MpPreference -DisableIntrusionPreventionSystem $true"
		$mutex1= "Global\\UFH_{DC27E4C7-C59E-4710-927B-9F9C958092B1}" wide
		
	condition:
		uint16be(0) == 0x4D5A and filesize < 700KB and
		( 2 of ($dll*)) or (any of ($s*)) or (2 of ($im*)) and (all of ($shell*)) and $mutex1
}
